name: Release

on:
  push:
    tags:
      - '*'
  release:
    types: [published]

permissions:
  contents: write
  packages: write

jobs:
  build-and-test:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: yarmcp-mcp
            context: ./mcp-server
          - service: yarmcp-updater
            context: ./updater

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get version
        id: version
        uses: ./.github/actions/get-version

      - name: Build, test and push Docker image to GHCR
        uses: ./.github/actions/docker-build-push
        with:
          service_name: ${{ matrix.service }}
          context_path: ${{ matrix.context }}
          ghcr_token: ${{ secrets.GITHUB_TOKEN }}
          build_mode: release
          docker_tag: ${{ steps.version.outputs.docker_tag }}
          full_version: ${{ steps.version.outputs.full_version }}
          build_args: |
            VERSION=${{ steps.version.outputs.full_version }}
            BUILD_TYPE=release

  create-draft-release:
    if: github.event_name == 'push'
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get version
        id: version
        uses: ./.github/actions/get-version

      - name: Create GitHub Release (Draft)
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: true
          prerelease: ${{ steps.version.outputs.is_prerelease == 'true' }}
          body: |
            ## Docker Images

            Available on GHCR (version `${{ steps.version.outputs.docker_tag }}`):

            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/yarmcp-mcp:${{ steps.version.outputs.docker_tag }}
            docker pull ghcr.io/${{ github.repository_owner }}/yarmcp-updater:${{ steps.version.outputs.docker_tag }}
            ```

            After this release is published, images will also be available on Docker Hub.

            ## Installation

            See [example/README.md](example/README.md) for deployment instructions.

  publish-tags:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: yarmcp-mcp
          - service: yarmcp-updater

    steps:
      - name: Checkout code at release tag
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Get version
        id: version
        uses: ./.github/actions/get-version

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: vars.DOCKERHUB_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull tested image from GHCR
        run: |
          SOURCE="ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:${{ steps.version.outputs.docker_tag }}"
          echo "Pulling ${SOURCE}"
          docker pull "${SOURCE}"
        shell: bash

      - name: Tag and push images
        shell: bash
        run: |
          DOCKER_TAG="${{ steps.version.outputs.docker_tag }}"
          IS_PRERELEASE="${{ steps.version.outputs.is_prerelease }}"
          SERVICE="${{ matrix.service }}"

          SOURCE_IMAGE="ghcr.io/${{ github.repository_owner }}/${SERVICE}:${DOCKER_TAG}"
          GHCR_IMAGE="ghcr.io/${{ github.repository_owner }}/${SERVICE}"
          DOCKERHUB_USERNAME="${{ vars.DOCKERHUB_USERNAME }}"
          DOCKERHUB_IMAGE="${DOCKERHUB_USERNAME}/${SERVICE}"

          # Helper: tag and push
          push_tag() {
            local TARGET_IMAGE="$1"
            local TAG="$2"
            echo "  Pushing ${TARGET_IMAGE}:${TAG}"
            docker tag "${SOURCE_IMAGE}" "${TARGET_IMAGE}:${TAG}"
            docker push "${TARGET_IMAGE}:${TAG}"
          }

          # 1. Push version tag to Docker Hub
          if [ -n "${DOCKERHUB_USERNAME}" ]; then
            echo "=== Pushing version tag to Docker Hub ==="
            push_tag "${DOCKERHUB_IMAGE}" "${DOCKER_TAG}"
          else
            echo "::warning::Docker Hub credentials not configured, skipping Docker Hub push"
          fi

          # 2. For stable (non-prerelease): push extra tags to GHCR + Docker Hub
          if [ "${IS_PRERELEASE}" != "true" ]; then
            echo "=== Pushing extra tags (stable release) ==="

            # Extract major.minor
            VERSION_CLEAN="${DOCKER_TAG#v}"
            if [[ "${VERSION_CLEAN}" =~ ^([0-9]+)\.([0-9]+) ]]; then
              MAJOR="${BASH_REMATCH[1]}"
              MINOR="${BASH_REMATCH[2]}"

              push_tag "${GHCR_IMAGE}" "${MAJOR}.${MINOR}"
              push_tag "${GHCR_IMAGE}" "${MAJOR}"

              if [ -n "${DOCKERHUB_USERNAME}" ]; then
                push_tag "${DOCKERHUB_IMAGE}" "${MAJOR}.${MINOR}"
                push_tag "${DOCKERHUB_IMAGE}" "${MAJOR}"
              fi
            fi

            push_tag "${GHCR_IMAGE}" "stable"
            push_tag "${GHCR_IMAGE}" "latest"

            if [ -n "${DOCKERHUB_USERNAME}" ]; then
              push_tag "${DOCKERHUB_IMAGE}" "stable"
              push_tag "${DOCKERHUB_IMAGE}" "latest"
            fi
          else
            echo "=== Prerelease: skipping stable/latest/major/minor tags ==="
          fi

          echo "=== Done ==="
